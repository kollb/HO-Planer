<!DOCTYPE html>
<html lang="de">
<head>
  <title>Home Office Planer</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%231976D2%22><path d=%22M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z%22/></svg>">
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.js"></script>
  <style>
    [v-cloak] { display: none !important; }
    body { font-family: 'Roboto', sans-serif; background-color: #121212; }
    .v-field__input { padding-top: 6px !important; padding-bottom: 6px !important; min-height: 32px !important; }
    
    /* Sticky Status Bar */
    .status-bar { position: sticky; top: 48px; z-index: 10; border-bottom: 1px solid rgba(128,128,128, 0.2); background: rgb(var(--v-theme-surface)); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stat-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; font-weight: 600; display: flex; align-items: center; justify-content: center; margin-bottom: 2px; }
    .stat-value { font-weight: 700; font-size: 0.95rem; line-height: 1.2; }

    /* Calendar Grid */
    .calendar-wrapper { display: grid; grid-template-columns: repeat(7, 1fr) 60px; gap: 6px; padding: 10px; }
    .cal-header { text-align: center; font-weight: bold; font-size: 0.85rem; padding-bottom: 5px; text-transform: uppercase; opacity: 0.7; }
    .cal-cell { border: 1px solid rgba(128,128,128, 0.2); border-radius: 8px; min-height: 110px; padding: 6px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: all 0.2s; position: relative; }
    .cal-cell:hover { border-color: #1976D2; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 2; transform: translateY(-2px); }
    
    .cal-cell.is-holiday { background-color: rgba(244, 67, 54, 0.05); border-color: rgba(244, 67, 54, 0.2); }
    .cal-cell.is-short-day { background-color: rgba(255, 152, 0, 0.05); border-color: rgba(255, 152, 0, 0.3); }
    .cal-cell.is-weekend { background-color: rgba(128,128,128, 0.03); }
    .cal-cell.is-off-day { background-color: rgba(0,0,0,0.02); opacity: 0.5; } 
    .cal-cell.is-today { border: 2px solid #1976D2; background-color: rgba(25, 118, 210, 0.1); }
    
    .status-home { background-color: rgba(76, 175, 80, 0.15); border-color: rgba(76, 175, 80, 0.5); }
    .status-office { background-color: rgba(255, 193, 7, 0.15); border-color: rgba(255, 193, 7, 0.5); }
    .status-sick { background-color: rgba(244, 67, 54, 0.15); }
    .status-vacation { background-color: rgba(156, 39, 176, 0.15); }
    .status-dr { background-color: rgba(33, 150, 243, 0.15); border-color: rgba(33, 150, 243, 0.5); }
    .status-planned { background-color: rgba(33, 150, 243, 0.08) !important; border: 1px dashed rgba(33, 150, 243, 0.6) !important; opacity: 0.9; }
    
    .cal-date { font-weight: bold; font-size: 1rem; margin-bottom: 4px; display: flex; align-items: center; }
    .cal-holiday-name { font-size: 0.7rem; color: #ef5350; line-height: 1.1; margin-bottom: 4px; font-weight: 500;}
    .cal-short-info { font-size: 0.7rem; color: #f57c00; font-weight: bold; margin-bottom: 4px; }
    .cal-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
    .cal-week-sum { display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.75rem; opacity: 0.7; writing-mode: vertical-rl; transform: rotate(180deg); background: rgba(128,128,128, 0.1); border-radius: 4px; }

    /* Table Rows */
    .day-row { transition: background-color 0.2s; border-bottom: 1px solid rgba(128,128,128, 0.1); }
    .day-row:hover { background-color: rgba(128,128,128, 0.1) !important; }
    .weekend, .holiday-row { background-color: rgba(128,128,128, 0.05); opacity: 0.8; }
    .week-summary-row { background-color: rgba(128,128,128, 0.1); height: 36px !important; }
    .week-summary-row td { font-weight: bold; font-size: 0.85rem; padding-top: 0 !important; padding-bottom: 0 !important; }
    
    .split-entry-box { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; margin-top: 8px; }

    @media (max-width: 600px) {
        .calendar-wrapper { gap: 2px; padding: 2px; grid-template-columns: repeat(7, 1fr) 25px; }
        .cal-cell { min-height: 50px; padding: 2px; border-radius: 4px; }
        .cal-holiday-name, .cal-short-info, .cal-content { display: none !important; }
        .cal-date { font-size: 0.8rem; margin: 0; }
        .stat-label { font-size: 0.55rem; }
        .stat-value { font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    <v-app>
      <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="4000" location="top">
         [[ snackbar.text ]]
         <template v-slot:actions><v-btn variant="text" @click="snackbar.show = false">OK</v-btn></template>
      </v-snackbar>

      <v-dialog v-model="importDialog.show" max-width="450">
          <v-card>
              <v-card-title class="bg-primary text-white">PDF Zeitnachweis Import</v-card-title>
              <v-card-text class="pt-4">
                  <p class="text-body-2 mb-2">Lädt den Zeitnachweis auf den Server und importiert die Zeiten.</p>
                  <v-checkbox v-model="importDialog.overwrite" label="Existierende Einträge überschreiben" hide-details class="mt-2" color="primary"></v-checkbox>
                  <div class="text-caption text-grey mt-2"><v-icon size="small" class="mr-1">mdi-alert-circle-outline</v-icon>Erkennt Monat, Jahr & den GLZ-Saldo automatisch. Unterstützt Pausenabzug und Split-Buchungen.</div>
              </v-card-text>
              <v-card-actions><v-spacer></v-spacer><v-btn variant="text" @click="importDialog.show = false">Abbrechen</v-btn><v-btn color="primary" @click="proceedWithUpload">Import starten</v-btn></v-card-actions>
          </v-card>
      </v-dialog>

      <v-dialog v-model="seriesDialog.show" max-width="500">
        <v-card>
            <v-card-title class="bg-primary text-white"><v-icon start>mdi-calendar-multiple</v-icon> Serien-Planer</v-card-title>
            <v-card-text class="pt-4">
                <v-row density="compact">
                    <v-col cols="6"><v-text-field v-model="seriesDialog.start" label="Von" type="date" variant="outlined" density="compact"></v-text-field></v-col>
                    <v-col cols="6"><v-text-field v-model="seriesDialog.end" label="Bis" type="date" variant="outlined" density="compact"></v-text-field></v-col>
                </v-row>
                <div class="mb-3 d-flex justify-space-between"><v-checkbox v-for="(day, idx) in ['Mo','Di','Mi','Do','Fr']" :key="idx" v-model="seriesDialog.weekdays" :value="idx" :label="day" density="compact" hide-details></v-checkbox></div>
                <v-select v-model="seriesDialog.type" :items="types" label="Status setzen auf" item-title="title" item-value="value" variant="outlined" density="comfortable"></v-select>
                <v-checkbox v-model="seriesDialog.overwrite" label="Vorhandene überschreiben" density="compact" color="warning"></v-checkbox>
            </v-card-text>
            <v-card-actions><v-spacer></v-spacer><v-btn variant="text" @click="seriesDialog.show = false">Abbrechen</v-btn><v-btn color="primary" @click="saveSeriesPlan">Ausführen</v-btn></v-card-actions>
        </v-card>
      </v-dialog>

      <input type="file" ref="pdfInput" style="display: none" accept=".pdf" @change="uploadPdf">

      <v-app-bar color="primary" density="compact" elevation="1">
        <v-app-bar-title class="font-weight-bold" style="cursor: pointer" @click="goHome">HO Planer <span class="text-caption opacity-70 ml-2">Connected</span></v-app-bar-title>
        <v-spacer></v-spacer>
        
        <v-tooltip text="Serien-Planer (Quick-Plan)" location="bottom"><template v-slot:activator="{ props }"><v-btn v-bind="props" icon="mdi-calendar-multiple" size="small" @click="openSeriesDialog" class="mr-1"></v-btn></template></v-tooltip>
        <v-tooltip text="PDF Zeitnachweis importieren" location="bottom"><template v-slot:activator="{ props }"><v-btn v-bind="props" icon="mdi-file-pdf-box" size="small" @click="$refs.pdfInput.click()" class="mr-3"></v-btn></template></v-tooltip>
        
        <v-divider vertical class="mx-2 my-3" color="white" thickness="2"></v-divider>
        <v-btn icon @click="toggleTheme" class="mr-2"><v-icon>[[ theme.global.current.dark ? 'mdi-weather-sunny' : 'mdi-weather-night' ]]</v-icon></v-btn>
        
        <v-btn-toggle v-model="viewMode" density="compact" mandatory class="mr-3" variant="outlined" color="white" divided>
            <v-btn value="list" icon="mdi-format-list-bulleted" @click="loadMonthData"></v-btn>
            <v-btn value="calendar" icon="mdi-calendar-month" @click="loadMonthData"></v-btn>
            <v-btn value="year" icon="mdi-chart-bar" @click="loadYearData"></v-btn>
        </v-btn-toggle>
        <v-btn icon @click="dialogSettings = true"><v-icon>mdi-cog</v-icon></v-btn>
      </v-app-bar>

      <v-main>
        <v-container fluid class="status-bar py-2 px-4 mb-3" v-if="viewMode !== 'year'">
            <div class="mx-auto" style="max-width: 1200px; width: 100%;">
                <v-row align="center" no-gutters>
                    <v-col cols="12" md="3" class="d-flex justify-center justify-md-start align-center mb-2 mb-md-0 pl-md-4">
                        <v-btn icon variant="text" size="small" @click="changeMonth(-1)"><v-icon>mdi-chevron-left</v-icon></v-btn>
                        <div class="font-weight-bold mx-2 text-center" style="line-height: 1.1; min-width: 140px;">
                            <div class="text-h6 font-weight-bold text-uppercase">[[ currentMonthName ]]</div><div class="text-caption opacity-60">[[ currentYear ]]</div>
                        </div>
                        <v-btn icon variant="text" size="small" @click="changeMonth(1)"><v-icon>mdi-chevron-right</v-icon></v-btn>
                    </v-col>
                    
                    <v-col cols="12" md="2" class="d-flex justify-center align-center">
                        <div class="d-flex" style="gap: 20px;">
                            <div class="text-center"><div class="stat-label"><v-icon size="x-small" class="mr-1">mdi-calendar-check</v-icon>Tage</div><div class="stat-value">[[ stats.workdays_month ]]</div></div>
                            <div class="text-center"><div class="stat-label"><v-icon size="x-small" class="mr-1">mdi-office-building</v-icon>Bürostd.</div><div class="stat-value text-amber-darken-2">[[ formatNum(stats.total_office_made) ]] <span class="text-caption opacity-60">h</span></div></div>
                        </div>
                    </v-col>

                    <v-col cols="6" md="3" class="d-flex justify-center align-center border-right">
                        <div class="d-flex flex-column align-center justify-center h-100">
                            <div class="text-caption text-uppercase font-weight-bold opacity-50 mb-0" style="font-size: 0.6rem !important;">Gleitzeit Saldo</div>
                            <div class="d-flex align-center mb-1">
                                 <span class="text-h6 font-weight-bold" :class="stats.current_glz >= 0 ? 'text-green-accent-3' : 'text-red-accent-2'" style="line-height: 1.1;">
                                     <span v-if="stats.current_glz > 0">+</span>[[ formatNum(stats.current_glz) ]] <span class="text-body-2 ml-1">h</span>
                                 </span>
                            </div>
                            <div class="d-flex align-center mt-0"><span class="text-caption opacity-60 font-weight-medium">Aktueller Monat</span></div>
                        </div>
                    </v-col>

                    <v-col cols="6" md="4" class="pl-4">
                        <div class="d-flex flex-column align-end justify-center h-100">
                            <div class="text-caption text-uppercase font-weight-bold opacity-50 mb-0" style="font-size: 0.6rem !important;">Home Office Budget</div>
                            <div class="d-flex align-center mb-1">
                                 <span class="text-subtitle-1 font-weight-bold" :class="budgetStateColor" style="line-height: 1.1;"><span v-if="budgetRemainingDays > 0">+</span>[[ formatOneDecimal(budgetRemainingDays) ]] Tage</span>
                                 <span class="text-caption font-weight-medium opacity-60 ml-2" :class="budgetStateColor">([[ formatNum(budgetRemainingHours) ]] h)</span>
                            </div>
                            <v-progress-linear :model-value="quotaPercentage" :color="getQuotaColor" height="6" rounded class="mb-1" style="width: 100%; max-width: 250px;" bg-color="grey-darken-3" bg-opacity="0.3"></v-progress-linear>
                            <div class="d-flex align-center mt-0"><span class="text-caption text-uppercase font-weight-bold opacity-40 mr-2">Genutzt:</span><span class="text-caption opacity-80 font-weight-medium">[[ formatNum(stats.total_ho_made) ]] / [[ formatNum(stats.total_ho_allowed) ]] h</span></div>
                        </div>
                    </v-col>
                </v-row>
            </div>
        </v-container>

        <v-container fluid class="status-bar py-3 px-4 mb-3" v-else>
            <div class="mx-auto" style="max-width: 1200px; width: 100%;">
                <v-row align="center" no-gutters>
                    <v-col cols="12" md="3" class="d-flex justify-center justify-md-start align-center mb-2 mb-md-0 pl-md-4">
                        <v-btn icon variant="text" size="small" @click="changeYear(-1)"><v-icon>mdi-chevron-left</v-icon></v-btn>
                        <div class="font-weight-bold mx-2 text-center" style="min-width: 120px;">Jahr [[ currentYear ]]</div>
                        <v-btn icon variant="text" size="small" @click="changeYear(1)"><v-icon>mdi-chevron-right</v-icon></v-btn>
                    </v-col>
                    <v-col cols="12" md="9" class="text-center text-md-right"><span class="stat-label">Jahresübersicht</span></v-col>
                </v-row>
            </div>
        </v-container>

        <v-container class="mx-auto" style="max-width: 1200px;">
            <v-card elevation="0" border min-height="500">
                
                <v-table density="compact" v-if="viewMode === 'list'" class="d-none d-md-block" style="width: 100%;">
                    <template v-slot:default>
                        <thead>
                            <tr style="background-color: rgba(128,128,128,0.05);">
                                <th class="text-left font-weight-bold">Datum</th>
                                <th class="text-left font-weight-bold" style="width:180px">Status</th>
                                <th class="text-left font-weight-bold" style="width:100px">Start</th>
                                <th class="text-left font-weight-bold" style="width:100px">Ende</th>
                                <th class="text-center font-weight-bold" style="width:140px">GLZ Saldo</th>
                                <th class="text-left font-weight-bold">Notiz</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="item in items" :key="item ? item.date : 'list-desk'">
                                <template v-if="item && item.row_type === 'day' && (!settings.hide_weekends || !isWeekend(item))">
                                    <tr v-for="(entry, index) in item.entries" :key="index"
                                        :class="{'weekend': isWeekend(item), 'off-day-row': item.is_off_day, 'holiday-row': item.is_holiday, 'is-today': isToday(item.date), 'day-row': true}">
                                        
                                        <td class="py-2" style="width: 180px; vertical-align: top;">
                                            <div v-if="index === 0">
                                                <div class="font-weight-medium">[[ item.day_num ]]. [[ getGermanDay(item.weekday_index) ]]</div>
                                                <div v-if="item.is_holiday" class="text-caption text-red-lighten-1 font-weight-bold">[[ item.holiday_name ]]</div>
                                            </div>
                                        </td>

                                        <td class="py-1">
                                            <v-select v-model="entry.type" :items="types" item-title="title" item-value="value" variant="plain" density="compact" hide-details class="mt-0 pt-0" @update:model-value="onEntryChange(item, entry)"></v-select>
                                        </td>
                                        <td>
                                            <v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.start" placeholder="08:00" variant="underlined" density="compact" hide-details :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(item.date, entry)"></v-text-field>
                                        </td>
                                        <td>
                                            <v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.end" placeholder="16:00" variant="underlined" density="compact" hide-details :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(item.date, entry)"></v-text-field>
                                        </td>
                                        
                                        <td class="text-center" style="vertical-align: top; padding-top: 10px;">
                                            <div v-if="index === 0" class="font-weight-bold" :class="item.glz_saldo >= 0 ? 'text-green' : 'text-red'">
                                                <span v-if="item.glz_saldo > 0">+</span>[[ formatNum(item.glz_saldo) ]] h
                                                <v-icon v-if="item.glz_override !== null" size="x-small" color="blue" class="ml-1" title="Offizieller GLZ Anker">mdi-anchor</v-icon>
                                            </div>
                                        </td>

                                        <td>
                                            <v-text-field v-model="entry.comment" placeholder="..." variant="plain" density="compact" hide-details @change="saveSingleEntry(item.date, entry)"></v-text-field>
                                        </td>
                                        <td style="vertical-align: top; padding-top: 5px;">
                                            <v-btn v-if="index === 0" icon size="small" variant="text" @click="openEditDialog(item)"><v-icon size="small">mdi-pencil</v-icon></v-btn>
                                            <v-btn v-else icon size="x-small" color="error" variant="text" @click="deleteEntry(item, index)"><v-icon>mdi-close</v-icon></v-btn>
                                        </td>
                                    </tr>
                                </template>
                                <tr v-else-if="item && item.row_type === 'summary'" class="week-summary-row"><td colspan="2" class="text-right pr-4">KW [[ item.iso_week ]] GESAMT:</td><td colspan="5"><span :class="getWeeklyColor(item.sum, item.target)">[[ formatNum(item.sum) ]] / [[ formatNum(item.target) ]] h</span></td></tr>
                            </template>
                        </tbody>
                    </template>
                </v-table>

                <div v-if="viewMode === 'list'" class="d-md-none pa-2">
                    <template v-for="item in items" :key="item ? 'mob-'+item.date : 'mob-unk'">
                        <v-card v-if="item && item.row_type === 'day' && (!settings.hide_weekends || !isWeekend(item))" class="mb-2" elevation="1" :class="{'is-today': isToday(item.date)}" @click="openEditDialog(item)">
                            <div class="d-flex justify-space-between align-center pa-2 pb-0">
                                <div>
                                    <span class="font-weight-bold text-subtitle-1">[[ item.day_num ]]. [[ getGermanDay(item.weekday_index) ]]</span>
                                    <span v-if="item.is_holiday" class="text-caption text-red ml-2">[[ item.holiday_name ]]</span>
                                </div>
                                <div>
                                    <span class="text-caption font-weight-bold mr-2" :class="item.glz_saldo >= 0 ? 'text-green' : 'text-red'">
                                        <v-icon v-if="item.glz_override !== null" size="x-small" color="blue" class="mr-1">mdi-anchor</v-icon>
                                        GLZ: <span v-if="item.glz_saldo > 0">+</span>[[ formatNum(item.glz_saldo) ]]
                                    </span>
                                    <v-chip v-if="item.total_net > 0" size="small" color="primary" variant="flat" class="font-weight-bold">[[ formatNum(item.total_net) ]] h</v-chip>
                                </div>
                            </div>
                            <div class="pa-2">
                                <div v-for="(entry, i) in item.entries" :key="i" class="text-caption d-flex align-center mt-1">
                                    <v-icon size="x-small" :color="getStatusIconColor(entry.type)" class="mr-1">[[ getStatusIcon(entry.type) ]]</v-icon>
                                    <span class="mr-2">[[ getTypeName(entry.type) ]]</span>
                                    <span v-if="entry.start">[[ entry.start ]]-[[ entry.end ]]</span>
                                    <span v-if="entry.comment" class="ml-2 text-grey">([[ entry.comment ]])</span>
                                </div>
                                <div v-if="item.entries[0].type === ''" class="text-caption text-grey">Kein Eintrag</div>
                            </div>
                        </v-card>
                        <div v-else-if="item && item.row_type === 'summary'" class="text-center py-2 mb-2 text-caption font-weight-bold text-uppercase" style="background: rgba(128,128,128,0.1); border-radius: 4px;">
                            KW [[ item.iso_week ]]: <span :class="getWeeklyColor(item.sum, item.target)" class="text-body-2 ml-1">[[ formatNum(item.sum) ]] / [[ formatNum(item.target) ]] h</span>
                        </div>
                    </template>
                </div>

                <div v-if="viewMode === 'calendar'" class="pa-2">
                    <div class="calendar-wrapper">
                        <div class="cal-header">Mo</div><div class="cal-header">Di</div><div class="cal-header">Mi</div><div class="cal-header">Do</div><div class="cal-header">Fr</div><div class="cal-header text-red">Sa</div><div class="cal-header text-red">So</div><div class="cal-header" style="font-size: 0.7rem">KW</div>
                        <div v-for="n in paddingDays" :key="'pad-'+n"></div>
                        <template v-for="item in items" :key="item ? item.date : 'cal-unk'">
                            <div v-if="item && item.row_type === 'day'" class="cal-cell"
                                 :class="{'is-holiday': item.is_holiday, 'is-weekend': isWeekend(item), 'is-today': isToday(item.date), 'is-short-day': item.is_short_day, 'is-off-day': item.is_off_day, 
                                          'status-home': item.main_type === 'home', 'status-office': item.main_type === 'office', 'status-planned': item.main_type === 'planned', 'status-sick': item.main_type === 'sick', 'status-vacation': item.main_type === 'vacation', 'status-dr': item.main_type === 'dr'}"
                                 @click="openEditDialog(item)">
                                <div class="d-flex justify-space-between align-start">
                                    <span class="cal-date" :class="{'opacity-50': item.is_off_day}">
                                        [[ item.day_num ]]
                                        <v-icon v-if="item.glz_override !== null" size="x-small" color="blue" class="ml-1" title="Offizieller GLZ Anker">mdi-anchor</v-icon>
                                    </span>
                                    <v-menu location="bottom end">
                                        <template v-slot:activator="{ props }"><v-btn icon="mdi-dots-vertical" variant="text" size="x-small" density="compact" v-bind="props" @click.stop class="opacity-50"></v-btn></template>
                                        <v-list density="compact">
                                            <v-list-item @click="quickSetStatus(item, 'home')" title="Home Office" prepend-icon="mdi-home" color="green"></v-list-item>
                                            <v-list-item @click="quickSetStatus(item, 'office')" title="Büro" prepend-icon="mdi-office-building" color="amber"></v-list-item>
                                            <v-list-item @click="quickSetStatus(item, '')" title="Löschen" prepend-icon="mdi-delete" color="grey"></v-list-item>
                                        </v-list>
                                    </v-menu>
                                </div>
                                <div v-if="item.is_holiday" class="cal-holiday-name">[[ item.holiday_name ]]</div>
                                <div class="cal-content">
                                    <div v-if="item.main_type" class="font-weight-bold text-caption text-uppercase" :style="{color: getStatusIconColor(item.main_type)}">[[ getTypeName(item.main_type) ]]</div>
                                    <div v-if="item.total_net > 0 || item.main_type === 'planned'" class="text-caption font-weight-bold">[[ formatNum(item.total_net) ]] h</div>
                                </div>
                            </div>
                            <div v-else-if="item && item.row_type === 'summary'" class="cal-week-sum" :title="'KW ' + item.iso_week"><span :class="getWeeklyColor(item.sum, item.target)" class="font-weight-bold">[[ formatNum(item.sum) ]]</span></div>
                        </template>
                    </div>
                </div>

                <v-table v-if="viewMode === 'year'" density="comfortable">
                    <template v-slot:default>
                        <thead><tr style="background-color: rgba(128,128,128,0.05);"><th class="text-left">Monat</th><th class="text-center">Home Office Tage</th><th class="text-center">Büro Tage</th><th class="text-center">Urlaub</th><th class="text-center">Budget Nutzung</th></tr></thead>
                        <tbody>
                            <tr v-for="stat in yearData" :key="stat.month">
                                <td class="font-weight-medium">[[ getGermanMonthName(stat.month) ]]</td>
                                <td class="text-center"><v-chip size="small" color="green" variant="flat" v-if="stat.days_ho > 0">[[ stat.days_ho ]] Tage</v-chip><span v-else class="opacity-50">-</span></td>
                                <td class="text-center"><v-chip size="small" color="amber-darken-2" variant="flat" v-if="stat.days_office > 0">[[ stat.days_office ]] Tage</v-chip><span v-else class="opacity-50">-</span></td>
                                <td class="text-center"><v-chip size="small" color="purple" variant="flat" v-if="stat.days_vacation > 0">[[ stat.days_vacation ]] Tage</v-chip><span v-else class="opacity-50">-</span></td>
                                <td class="text-center"><div class="d-flex align-center justify-center"><div style="width: 120px" class="mr-2"><v-progress-linear :model-value="stat.ho_hours_allowed ? (stat.ho_hours_made / stat.ho_hours_allowed)*100 : 0" color="blue" height="6" rounded></v-progress-linear></div><span class="text-caption">[[ formatNum(stat.ho_hours_made) ]] / [[ formatNum(stat.ho_hours_allowed) ]] h</span></div></td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-grey-darken-4 font-weight-bold" style="border-top: 4px solid rgba(255,255,255,0.2);">
                            <tr>
                                <td class="text-left py-3">GESAMT</td>
                                <td class="text-center"><v-chip size="small" color="green" variant="elevated">[[ yearTotalHo ]] Tage</v-chip></td>
                                <td class="text-center"><v-chip size="small" color="amber-darken-2" variant="elevated">[[ yearTotalOffice ]] Tage</v-chip></td>
                                <td class="text-center"><v-chip size="small" color="purple" variant="elevated">[[ yearTotalVacation ]] Tage</v-chip></td>
                                <td class="text-center"><!-- [[ formatNum(yearTotalHoHours) ]] / [[ formatNum(yearTotalAllowed) ]] h--></td>
                            </tr>
                        </tfoot>
                    </template>
                </v-table>
            </v-card>
        </v-container>
      </v-main>

      <v-dialog v-model="dialogEditDay" max-width="500">
        <v-card v-if="editingDay">
            <v-card-title class="bg-primary text-white d-flex justify-space-between align-center"><span>[[ editingDay.day_num ]]. [[ currentMonthName ]]</span><span class="text-caption text-uppercase">[[ getGermanDay(editingDay.weekday_index) ]]</span></v-card-title>
            <v-card-text class="pt-4 pb-2">
                <div class="quick-btn-group d-flex justify-center mb-4" style="gap: 8px; flex-wrap: wrap;">
                    <v-btn v-for="t in ['home', 'office', 'planned', 'sick', 'vacation']" :key="t" size="small" variant="tonal"
                           :color="editingDay.entries[0] && editingDay.entries[0].type === t ? getStatusIconColor(t) : 'grey'"
                           @click="setPrimaryType(editingDay, t)">[[ getTypeName(t) ]]
                    </v-btn>
                </div>
                
                <div v-if="editingDay.entries.length > 0" class="mb-2">
                    <v-row dense>
                        <v-col cols="6"><v-text-field v-if="needsTimeInput(editingDay.entries[0].type)" v-model="editingDay.entries[0].start" label="Start" placeholder="08:00" variant="outlined" density="compact" hide-details :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(editingDay.date, editingDay.entries[0])"></v-text-field></v-col>
                        <v-col cols="6"><v-text-field v-if="needsTimeInput(editingDay.entries[0].type)" v-model="editingDay.entries[0].end" label="Ende" placeholder="16:00" variant="outlined" density="compact" hide-details :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(editingDay.date, editingDay.entries[0])"></v-text-field></v-col>
                        <v-col cols="12" class="mt-2"><v-text-field v-model="editingDay.entries[0].comment" label="Notiz" variant="outlined" density="compact" hide-details placeholder="..." @change="saveSingleEntry(editingDay.date, editingDay.entries[0])"></v-text-field></v-col>
                    </v-row>
                </div>

                <div v-if="editingDay.entries.length > 1">
                    <v-divider class="my-3"></v-divider>
                    <div class="text-caption font-weight-bold mb-2">Split-Einträge:</div>
                    <div v-for="(entry, index) in editingDay.entries" :key="index">
                        <div v-if="index > 0" class="mb-3 pa-2 split-entry-box position-relative">
                            <v-btn icon size="x-small" color="error" variant="text" style="position: absolute; top: 0; right: 0;" @click="deleteEntry(editingDay, index)"><v-icon>mdi-close</v-icon></v-btn>
                            <v-row dense align="center">
                                <v-col cols="12"><v-select v-model="entry.type" :items="types" label="Status" variant="underlined" density="compact" hide-details @update:model-value="saveSingleEntry(editingDay.date, entry)"></v-select></v-col>
                                <v-col cols="6"><v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.start" label="Start" placeholder="08:00" variant="underlined" density="compact" hide-details :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(editingDay.date, entry)"></v-text-field></v-col>
                                <v-col cols="6"><v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.end" label="Ende" placeholder="16:00" variant="underlined" density="compact" hide-details :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(editingDay.date, entry)"></v-text-field></v-col>
                                <v-col cols="12"><v-text-field v-model="entry.comment" label="Notiz" variant="plain" density="compact" hide-details @change="saveSingleEntry(editingDay.date, entry)"></v-text-field></v-col>
                            </v-row>
                        </div>
                    </div>
                </div>

                <v-btn variant="text" size="small" color="primary" @click="addEntryToDay(editingDay)" class="mt-1"><v-icon start>mdi-plus</v-icon> Split hinzufügen</v-btn>
                
                <v-divider class="my-3"></v-divider>
                <div class="bg-surface-variant pa-3 rounded">
                    <div class="text-caption font-weight-bold mb-1"><v-icon size="small" class="mr-1" color="blue">mdi-anchor</v-icon>GLZ-Korrektur (Override)</div>
                    <div class="text-caption opacity-70 mb-2">Berechneter Stand an diesem Tag: <strong>[[ formatNum(editingDay.glz_saldo) ]] h</strong></div>
                    <v-text-field 
                        v-if="editingDay.entries && editingDay.entries.length > 0"
                        v-model.number="editingDay.entries[0].glz_override" 
                        label="Offiziellen Stand eintragen (überschreibt Berechnung)" 
                        placeholder="z.B. 12.5" 
                        variant="outlined" density="compact" hide-details type="number" step="0.01" 
                        @change="saveSingleEntry(editingDay.date, editingDay.entries[0])">
                    </v-text-field>
                </div>
            </v-card-text>
            <v-card-actions><v-spacer></v-spacer><v-btn color="primary" @click="dialogEditDay = false">Fertig</v-btn></v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog v-model="dialogSettings" max-width="700">
        <v-card>
          <v-card-title>Einstellungen</v-card-title>
          <v-card-text>
            <v-row>
              <v-col cols="6"><v-text-field v-model.number="settings.weekly_hours" label="Wochenstunden" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              <v-col cols="6"><v-text-field v-model.number="settings.ho_quota_percent" label="HO Quote %" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              <v-col cols="12" class="pt-0"><div class="text-caption mb-1">Arbeitstage</div><div class="d-flex justify-space-between"><v-checkbox v-for="(d, i) in ['Mo','Di','Mi','Do','Fr']" :key="i" v-model="settings.active_weekdays" :value="i" :label="d" density="compact" hide-details></v-checkbox></div></v-col>
              <v-col cols="6"><v-text-field v-model="settings.default_start_time" label="Startzeit" type="time" density="compact" variant="outlined"></v-text-field></v-col>
              <v-col cols="6"><v-switch v-model="settings.auto_convert_planned" label="Auto-Convert Geplant" color="primary" density="compact"></v-switch></v-col>
            </v-row>
            <v-divider class="my-2"></v-divider>
            <div class="text-subtitle-2 mb-2">Eigene Feiertage <v-btn size="x-small" variant="text" color="primary" @click="addWaeldchestag">Wäldchestag</v-btn></div>
            <div v-for="(h, i) in customHolidays" :key="i" class="d-flex align-center mb-1"><div style="width:90px" class="text-caption">[[ h.date ]]</div><div class="text-caption font-weight-bold mr-2">[[ h.name ]]</div><v-icon size="x-small" color="red" @click="deleteCustomHoliday(h.id)">mdi-delete</v-icon></div>
            <div class="d-flex mt-1"><v-text-field v-model="newCustomHoliday.date" type="date" density="compact" variant="outlined" hide-details class="mr-2"></v-text-field><v-text-field v-model="newCustomHoliday.name" label="Name" density="compact" variant="outlined" hide-details class="mr-2"></v-text-field><v-btn icon="mdi-plus" size="small" color="primary" @click="addCustomHoliday"></v-btn></div>
          </v-card-text>
          <v-card-actions><v-spacer></v-spacer><v-btn color="primary" @click="saveSettings">Schließen</v-btn></v-card-actions>
        </v-card>
      </v-dialog>
    </v-app>
  </div>
  <script>
    const { createApp } = Vue; const { createVuetify } = Vuetify; const vuetify = createVuetify({ theme: { defaultTheme: 'dark' } });
    
    const app = createApp({
      data() { return {
          viewMode: 'list', currentDate: new Date(), items: [], yearData: [],
          stats: { total_ho_made: 0, total_ho_allowed: 1, total_office_made: 0, total_work_made: 0, avg_per_week: 0, workdays_month: 0, current_glz: 0 }, 
          settings: { weekly_hours: 39, active_weekdays: [0,1,2,3,4], ho_quota_percent: 60, hide_weekends: false, default_start_time: '08:00', auto_convert_planned: true },
          dialogSettings: false, dialogEditDay: false, editingDay: null, 
          importDialog: { show: false, overwrite: false, file: null },
          seriesDialog: { show: false, start: '', end: '', weekdays: [4], type: 'planned', overwrite: false },
          customHolidays: [], newCustomHoliday: { date: '', name: '', hours: 0 },
          snackbar: { show: false, text: '', color: 'success' },
          types: [{ title: 'Home Office', value: 'home' }, { title: 'Büro', value: 'office' }, { title: 'Geplant (HO)', value: 'planned' }, { title: 'Krank', value: 'sick' }, { title: 'Urlaub', value: 'vacation' }, { title: 'Gleitzeit', value: 'glz' }, { title: 'Dienstreise', value: 'dr' }, { title: 'Leer', value: '' }]
      }},
      computed: {
        currentYear() { return this.currentDate.getFullYear() },
        currentMonth() { return this.currentDate.getMonth() + 1 }, 
        currentMonthName() { return this.currentDate.toLocaleString('de-DE', { month: 'long' }) },
        quotaPercentage() { if(!this.stats.total_ho_allowed) return 0; return (this.stats.total_ho_made / this.stats.total_ho_allowed) * 100; },
        getQuotaColor() { return this.quotaPercentage > 100 ? 'red' : (this.quotaPercentage > 85 ? 'orange' : 'green-accent-3'); },
        paddingDays() { if(!this.items || this.items.length === 0) return 0; const firstDay = this.items.find(i => i.row_type === 'day'); return firstDay ? firstDay.weekday_index : 0; },
        theme() { return this.$vuetify.theme },
        calcDailyTarget() { const activeCount = this.settings.active_weekdays ? this.settings.active_weekdays.length : 5; if (activeCount === 0) return 0; return this.settings.weekly_hours / activeCount; },
        budgetRemainingHours() { return this.stats.total_ho_allowed - this.stats.total_ho_made; },
        budgetRemainingDays() { const daily = this.calcDailyTarget || 7.8; if(daily === 0) return 0; return this.budgetRemainingHours / daily; },
        budgetStateColor() { return this.budgetRemainingHours >= 0 ? 'text-green-accent-3' : 'text-red-accent-2'; },
        
        yearTotalHo() { return this.yearData.reduce((sum, item) => sum + item.days_ho, 0); },
        yearTotalOffice() { return this.yearData.reduce((sum, item) => sum + item.days_office, 0); },
        yearTotalVacation() { return this.yearData.reduce((sum, item) => sum + item.days_vacation, 0); },
        yearTotalHoHours() { return this.yearData.reduce((sum, item) => sum + item.ho_hours_made, 0); },
        yearTotalAllowed() { return this.yearData.reduce((sum, item) => sum + item.ho_hours_allowed, 0); }
      },
      watch: { viewMode(newVal) { if(newVal === 'year') this.loadYearData(); else this.loadMonthData(); } },
      mounted() { this.loadSettings(); this.loadCustomHolidays(); this.loadMonthData(); },
      methods: {
        goHome() { window.location.reload(); },
        toggleTheme() { this.theme.global.name = this.theme.global.current.dark ? 'light' : 'dark'; },
        formatNum(val) { return val || val === 0 ? val.toFixed(2).replace('.', ',') : '0,00'; },
        formatOneDecimal(val) { return val || val === 0 ? val.toFixed(1).replace('.', ',') : '0,0'; },
        showMsg(text, color='success') { this.snackbar.text = text; this.snackbar.color = color; this.snackbar.show = true; },
        
        // --- API & Import Logic ---
        uploadPdf(event) { const file = event.target.files[0]; if (!file) return; this.importDialog.file = file; this.importDialog.show = true; event.target.value = ''; },
        async proceedWithUpload() {
            this.importDialog.show = false; const formData = new FormData(); formData.append('file', this.importDialog.file); formData.append('overwrite', this.importDialog.overwrite);
            try { this.showMsg("Importiere PDF...", "info"); const res = await fetch('/api/import/pdf', { method: 'POST', body: formData }); const data = await res.json();
                if (res.ok && data.success) { this.showMsg(data.message, "success"); this.loadMonthData(); if(this.viewMode === 'year') this.loadYearData(); } else { this.showMsg(data.message || "Fehler", "error"); }
            } catch (e) { this.showMsg("Upload fehlgeschlagen: " + e, "error"); }
        },
        
        // --- Helpers ---
        getGermanDay(index) { return ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][index] || ''; },
        getGermanMonthName(m) { if(!m) return ""; const d = new Date(); d.setMonth(m-1); return d.toLocaleString('de-DE', { month: 'long' }); },
        isWeekend(day) { return day.weekday_index >= 5; },
        isToday(dateStr) { return dateStr === new Date().toISOString().split('T')[0]; },
        needsTimeInput(type) { return ['home', 'office', 'dr', '', null].includes(type); },
        getStatusIcon(type) { const map = { 'home': 'mdi-home', 'office': 'mdi-office-building', 'planned': 'mdi-calendar-clock', 'sick': 'mdi-emoticon-sick', 'vacation': 'mdi-beach', 'dr': 'mdi-car' }; return map[type] || ''; },
        getStatusIconColor(type) { const map = { 'home': 'green', 'office': 'amber-darken-4', 'planned': 'blue', 'sick': 'red', 'vacation': 'purple', 'dr': 'blue' }; return map[type] || 'grey'; },
        getTypeName(val) { const found = this.types.find(t => t.value === val); return found ? found.title : ''; },
        getWeeklyColor(current, target) { if (!current) return 'text-grey'; return current >= target ? 'text-green-darken-2' : 'text-orange-darken-2'; },
        
        // --- Entry Management ---
        openEditDialog(day) { 
            this.editingDay = day; 
            if(!this.editingDay.entries || this.editingDay.entries.length === 0) { this.editingDay.entries = [{type: 'home', start: '', end: '', net: 0, comment: '', glz_override: null}]; } 
            this.dialogEditDay = true; 
        },
        quickSetStatus(day, newType) {
            if(newType === '') { if(day.entries.length > 0) { if(day.entries[0].id) this.deleteEntry(day, 0); else { day.entries = []; this.loadMonthData(); } } return; }
            if(day.entries.length === 0) this.addEntryToDay(day);
            const entry = day.entries[0]; entry.type = newType; this.onEntryChange(day, entry); 
        },
        setPrimaryType(day, type) { if(day.entries.length === 0) this.addEntryToDay(day); const entry = day.entries[0]; entry.type = type; this.onEntryChange(day, entry); },
        addEntryToDay(day) { day.entries.push({type: 'home', start: '', end: '', net: 0, comment: '', glz_override: null}); },
        
        async deleteEntry(day, index) { 
            const entry = day.entries[index]; 
            if(entry.id) { try { await fetch(`/api/entry/${entry.id}`, { method: 'DELETE' }); } catch(e) {} } 
            day.entries.splice(index, 1); 
            if(day.entries.length === 0) { day.entries = [{type: '', start: '', end: '', net: 0, glz_override: null}]; } 
            this.loadMonthData(); 
        },
        
        onEntryChange(day, entry) { 
             if(['home', 'office', 'dr'].includes(entry.type) && !entry.start) {
                entry.start = this.settings.default_start_time || '08:00';
                if(day.entries.length === 1) {
                     const dailyTarget = this.calcDailyTarget;
                     let startMin = 480; try { let p = entry.start.split(':'); startMin = parseInt(p[0])*60 + parseInt(p[1]); } catch(e){}
                     let grossHours = dailyTarget; if(dailyTarget > 9) grossHours += 0.75; else if(dailyTarget > 6) grossHours += 0.5;
                     const endMin = startMin + (grossHours * 60); const h = Math.floor(endMin / 60); const m = Math.round(endMin % 60);
                     entry.end = `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
                }
             } this.saveSingleEntry(day.date, entry); 
        },
        
        async saveSingleEntry(dateStr, entry) { 
            const payload = { ...entry, date: dateStr }; 
            const res = await fetch('/api/entry', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); 
            if(res.ok) { const data = await res.json(); if(data.id) entry.id = data.id; this.loadMonthData(); }
        },
        
        // --- Series Planner ---
        openSeriesDialog() { const nextM = new Date(); nextM.setMonth(nextM.getMonth() + 1); const y = nextM.getFullYear(), m = nextM.getMonth(); const lastDay = new Date(y, m + 1, 0).getDate(); this.seriesDialog.start = `${y}-${(m+1).toString().padStart(2,'0')}-01`; this.seriesDialog.end = `${y}-${(m+1).toString().padStart(2,'0')}-${lastDay}`; this.seriesDialog.show = true; },
        async saveSeriesPlan() { this.seriesDialog.show = false; this.showMsg("Führe Serienplanung aus...", "info"); const payload = { start: this.seriesDialog.start, end: this.seriesDialog.end, weekdays: this.seriesDialog.weekdays, type: this.seriesDialog.type, overwrite: this.seriesDialog.overwrite }; try { const res = await fetch('/api/plan/series', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); if(res.ok) { this.showMsg("Planung erfolgreich!", "success"); this.loadMonthData(); } else { this.showMsg("Fehler beim Speichern", "error"); } } catch(e) { this.showMsg("Fehler: " + e, "error"); } },
        
        // --- Navigation & Data Loading ---
        changeMonth(delta) { this.currentDate = new Date(this.currentDate.setMonth(this.currentDate.getMonth() + delta)); this.loadMonthData(); },
        changeYear(delta) { this.currentDate = new Date(this.currentDate.setFullYear(this.currentDate.getFullYear() + delta)); if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData(); },
        async loadSettings() { try { const res = await fetch('/api/settings'); if(res.ok) this.settings = await res.json(); } catch(e){} },
        async loadCustomHolidays() { try { const res = await fetch('/api/custom-holidays'); if(res.ok) this.customHolidays = await res.json(); } catch(e){} },
        async addCustomHoliday() { if(!this.newCustomHoliday.date || !this.newCustomHoliday.name) return; await fetch('/api/custom-holidays', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.newCustomHoliday) }); this.newCustomHoliday.date = ''; this.newCustomHoliday.name = ''; this.loadCustomHolidays(); if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData(); },
        async deleteCustomHoliday(id) { await fetch(`/api/custom-holidays/${id}`, { method: 'DELETE' }); this.loadCustomHolidays(); if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData(); },
        async saveSettings() { await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.settings) }); this.dialogSettings = false; if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData(); },
        async loadMonthData() { 
            try { 
                const res = await fetch(`/api/month/${this.currentYear}/${this.currentMonth}`); const data = await res.json(); 
                this.items = data.items || []; this.stats = data.stats || {}; 
                this.items.forEach(item => { if (item.row_type === 'day' && item.entries.length === 0) { item.entries.push({type: '', start: '', end: '', net: 0, comment: '', glz_override: null}); } });
            } catch(e){} 
        },
        async loadYearData() { try { const res = await fetch(`/api/year/${this.currentYear}`); if(res.ok) this.yearData = await res.json(); } catch(e) { console.error(e); } },
        addWaeldchestag() { const y = this.currentYear; const a=y%19, b=Math.floor(y/100), c=y%100, dd=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-dd-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m_easter=Math.floor((a+11*h+22*l)/451); const monthE = Math.floor((h+l-7*m_easter+114)/31); const dayE = ((h+l-7*m_easter+114)%31)+1; const easterDate = new Date(y, monthE - 1, dayE); const waeldchestag = new Date(easterDate); waeldchestag.setDate(easterDate.getDate() + 51); const dateStr = new Date(waeldchestag.getTime() - (waeldchestag.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; this.newCustomHoliday.date = dateStr; this.newCustomHoliday.name = 'Wäldchestag'; this.newCustomHoliday.hours = 6.0; this.addCustomHoliday(); this.showMsg("Wäldchestag " + y + " hinzugefügt.", "success"); }
      }
    });
    
    app.config.compilerOptions.delimiters = ['[[', ']]'];
    app.use(vuetify);
    app.mount('#app');
  </script>
</body>
</html>